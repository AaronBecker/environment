#!/bin/bash
# a command line twitter client (using .netrc for auth)
# adapted from cutup.org/anize

name=""

function friends {
    curl --connect-timeout 5 -s -n $1 | awk -vfilter_name="$name" '
        { sub(/^[^>]*>/,"",$0) }
        /text/ { 
         sub(/<[^<]*>$/,"",$0)
         gsub(/&quot;/,"\"",$0)
         gsub(/&amp;/,"&",$0)
         gsub(/$lt;/,"<",$0)
         gsub(/$gt;/,">",$0)
         m=$0
        }
        /created_at/ { 
         sub(/<[^<]*>$/,"",$0)
         split($0,at,"+")
        }
        /[^_]screen_name/ { 
         sub(/<[^<]*>$/,"",$0)
         screen_name=$0
         if (match(tolower(screen_name), tolower(filter_name)) != 0) 
             print screen_name "\n" m "\n[ " at[1] "]\n"
        }
        '
}


function update {
    curl -s -n -d "status=$msg" $1 &>/dev/null && \
        echo "tweet posted" || \
        echo "tweet broke, post failed"
}


exename=$(basename $0)

while [ $# != 0 ]; do
    flag=$1
    shift
    case $flag in
        "-h")
        echo " Usage: $exename -uh | [ tweet ]"
        echo "      -h                  display this message and exit"
        echo "      -n NAME             display updates from screen name NAME only"
        echo " If [tweet] is provided, it is sent as a status update. Otherwise, "
        echo " a list of your friends' updates is given."
        exit
        ;;

        "-n")
        name="$1"
        shift
        ;;
    esac
done

if [ -t 0 ]; then
    msg="$*"
else
    msg="$(cat -)"
fi

if [ "$msg" ]; then
    update http://twitter.com/statuses/update.xml
else
    friends http://twitter.com/statuses/friends_timeline.xml | fold -s | less -FXR
fi

